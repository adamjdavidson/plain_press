<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Article Admin - Plain Press</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 { margin: 0 0 20px; color: #2d5016; }

    .stats {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .stat-box {
      background: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .stat-box strong { font-size: 24px; color: #2d5016; }
    .stat-box span { display: block; color: #666; font-size: 12px; }

    .filters {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    .filters label { font-weight: 500; }
    .filters select, .filters input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .filters button {
      padding: 8px 16px;
      background: #2d5016;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .filters button:hover { background: #1e3a0f; }

    .bulk-actions {
      background: #fff3cd;
      padding: 10px 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
      align-items: center;
      gap: 10px;
    }
    .bulk-actions.visible { display: flex; }
    .bulk-actions button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    .btn-pending { background: #17a2b8; color: white; }
    .btn-reject { background: #dc3545; color: white; }
    .btn-delete { background: #6c757d; color: white; }

    table {
      width: 100%;
      background: white;
      border-collapse: collapse;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      background: #2d5016;
      color: white;
      font-weight: 500;
      position: sticky;
      top: 0;
    }
    th:first-child { width: 30px; }
    tr:hover { background: #f9f9f9; }

    /* Sortable column headers */
    th.sortable {
      cursor: pointer;
      user-select: none;
    }
    th.sortable a {
      color: white;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    th.sortable:hover {
      background: #1e3a0f;
    }
    th .sort-indicator {
      opacity: 0.5;
      font-size: 10px;
    }
    th.sorted .sort-indicator {
      opacity: 1;
    }

    .status {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status-pending { background: #e3f2fd; color: #1565c0; }
    .status-emailed { background: #fff3e0; color: #ef6c00; }
    .status-good { background: #e8f5e9; color: #2e7d32; }
    .status-rejected { background: #ffebee; color: #c62828; }
    .status-published { background: #f3e5f5; color: #7b1fa2; }

    .score {
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
    }
    .score-high { background: #e8f5e9; color: #2e7d32; }
    .score-med { background: #fff3e0; color: #ef6c00; }
    .score-low { background: #ffebee; color: #c62828; }

    .headline {
      max-width: 600px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-height: 1.4;
    }
    .date-added {
      font-size: 12px;
      color: #666;
      white-space: nowrap;
    }
    .headline a { color: #333; text-decoration: none; }
    .headline a:hover { color: #2d5016; }

    .source { color: #666; font-size: 13px; }

    .actions button {
      padding: 4px 8px;
      margin-right: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      font-size: 12px;
    }
    .actions button:hover { background: #f0f0f0; }

    .pagination {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      justify-content: center;
      align-items: center;
    }
    .pagination a, .pagination span {
      padding: 8px 12px;
      background: white;
      border-radius: 4px;
      text-decoration: none;
      color: #333;
    }
    .pagination a:hover { background: #e0e0e0; }
    .pagination .current { background: #2d5016; color: white; }

    .notes {
      max-width: 200px;
      font-size: 12px;
      color: #666;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .topics {
      font-size: 11px;
      color: #555;
      max-width: 150px;
    }
    .topic-tag {
      display: inline-block;
      background: #e8f4f8;
      color: #2c5282;
      padding: 2px 6px;
      border-radius: 10px;
      margin: 1px;
      font-size: 10px;
    }

    .select-all-container { display: flex; align-items: center; gap: 5px; }
  </style>
</head>
<body>
  <h1>Article Admin</h1>
  <p style="color: #666; margin-top: -15px; margin-bottom: 20px;"><a href="/admin/sources" style="color: #2d5016;">Manage RSS Feeds →</a></p>

  <div class="stats">
    <div class="stat-box">
      <strong>{{ stats.total }}</strong>
      <span>Total Articles</span>
    </div>
    <div class="stat-box">
      <strong>{{ stats.pending }}</strong>
      <span>Pending</span>
    </div>
    <div class="stat-box">
      <strong>{{ stats.emailed }}</strong>
      <span>Emailed</span>
    </div>
    <div class="stat-box">
      <strong>{{ stats.good }}</strong>
      <span>Good</span>
    </div>
    <div class="stat-box">
      <strong>{{ stats.rejected }}</strong>
      <span>Rejected</span>
    </div>
    <div class="stat-box">
      <strong>{{ stats.published }}</strong>
      <span>Published</span>
    </div>
    <div class="stat-box">
      <strong>{{ stats.high_score }}</strong>
      <span>Score >= 0.5</span>
    </div>
  </div>

  <form class="filters" method="GET" action="/admin/articles">
    <label>Status:</label>
    <select name="status">
      <option value="">All</option>
      <option value="pending" {{ 'selected' if filters.status == 'pending' else '' }}>Pending</option>
      <option value="emailed" {{ 'selected' if filters.status == 'emailed' else '' }}>Emailed</option>
      <option value="good" {{ 'selected' if filters.status == 'good' else '' }}>Good</option>
      <option value="rejected" {{ 'selected' if filters.status == 'rejected' else '' }}>Rejected</option>
      <option value="published" {{ 'selected' if filters.status == 'published' else '' }}>Published</option>
    </select>

    <label>Min Score:</label>
    <input type="number" name="min_score" step="0.1" min="0" max="1"
           value="{{ filters.min_score if filters.min_score else '' }}" placeholder="0.0" style="width: 80px;">

    <label>Source:</label>
    <select name="source">
      <option value="">All Sources</option>
      {% for source in sources %}
      <option value="{{ source }}" {{ 'selected' if filters.source == source else '' }}>{{ source }}</option>
      {% endfor %}
    </select>

    <label>Search:</label>
    <input type="text" name="search" value="{{ filters.search or '' }}" placeholder="Headline..." style="width: 150px;">

    <button type="submit">Filter</button>
    <a href="/admin/articles" style="padding: 8px 12px; color: #666;">Clear</a>
  </form>

  <div class="bulk-actions" id="bulkActions">
    <span><strong id="selectedCount">0</strong> selected</span>
    <button class="btn-pending" onclick="bulkAction('pending')">Reset to Pending</button>
    <button onclick="bulkAction('published')" style="background: #7b1fa2; color: white;">Mark Published</button>
    <button class="btn-reject" onclick="bulkAction('reject')">Mark Rejected</button>
    <button class="btn-delete" onclick="bulkAction('delete')">Delete</button>
  </div>

  <table>
    <thead>
      <tr>
        <th><input type="checkbox" id="selectAll" onchange="toggleAll(this)"></th>
        <th class="sortable {% if sort == 'status' %}sorted{% endif %}">
          <a href="{{ url_for('main.admin_articles', status=filters.status, min_score=filters.min_score, source=filters.source, search=filters.search, sort='status', dir='desc' if sort == 'status' and dir == 'asc' else 'asc') }}">
            Status <span class="sort-indicator">{% if sort == 'status' %}{{ '▲' if dir == 'asc' else '▼' }}{% endif %}</span>
          </a>
        </th>
        <th class="sortable {% if sort == 'score' %}sorted{% endif %}">
          <a href="{{ url_for('main.admin_articles', status=filters.status, min_score=filters.min_score, source=filters.source, search=filters.search, sort='score', dir='asc' if sort == 'score' and dir == 'desc' else 'desc') }}">
            Score <span class="sort-indicator">{% if sort == 'score' %}{{ '▲' if dir == 'asc' else '▼' }}{% endif %}</span>
          </a>
        </th>
        <th class="sortable {% if sort == 'headline' %}sorted{% endif %}">
          <a href="{{ url_for('main.admin_articles', status=filters.status, min_score=filters.min_score, source=filters.source, search=filters.search, sort='headline', dir='desc' if sort == 'headline' and dir == 'asc' else 'asc') }}">
            Headline <span class="sort-indicator">{% if sort == 'headline' %}{{ '▲' if dir == 'asc' else '▼' }}{% endif %}</span>
          </a>
        </th>
        <th>Topics</th>
        <th class="sortable {% if sort == 'source' %}sorted{% endif %}">
          <a href="{{ url_for('main.admin_articles', status=filters.status, min_score=filters.min_score, source=filters.source, search=filters.search, sort='source', dir='desc' if sort == 'source' and dir == 'asc' else 'asc') }}">
            Source <span class="sort-indicator">{% if sort == 'source' %}{{ '▲' if dir == 'asc' else '▼' }}{% endif %}</span>
          </a>
        </th>
        <th class="sortable {% if sort == 'date' %}sorted{% endif %}">
          <a href="{{ url_for('main.admin_articles', status=filters.status, min_score=filters.min_score, source=filters.source, search=filters.search, sort='date', dir='asc' if sort == 'date' and dir == 'desc' else 'desc') }}">
            Added <span class="sort-indicator">{% if sort == 'date' %}{{ '▲' if dir == 'asc' else '▼' }}{% endif %}</span>
          </a>
        </th>
        <th>Filter Notes</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for article in articles %}
      <tr data-id="{{ article.id }}">
        <td><input type="checkbox" class="row-select" value="{{ article.id }}" onchange="updateBulkActions()"></td>
        <td><span class="status status-{{ article.status.value }}">{{ article.status.value }}</span></td>
        <td>
          <span class="score {% if article.filter_score >= 0.7 %}score-high{% elif article.filter_score >= 0.5 %}score-med{% else %}score-low{% endif %}">
            {{ "%.2f"|format(article.filter_score) }}
          </span>
        </td>
        <td class="headline">
          <a href="{{ article.external_url }}" target="_blank" title="{{ article.headline }}">{{ article.headline }}</a>
        </td>
        <td class="topics">
          {% if article.topics %}
            {% for topic in article.topics %}
              <span class="topic-tag">{{ topic }}</span>
            {% endfor %}
          {% else %}
            -
          {% endif %}
        </td>
        <td class="source">{{ article.source_name }}</td>
        <td class="date-added">{{ article.discovered_date.strftime('%b %d') if article.discovered_date else (article.created_at.strftime('%b %d') if article.created_at else '-') }}</td>
        <td class="notes" title="{{ article.filter_notes or '' }}">{{ article.filter_notes or '-' }}</td>
        <td class="actions">
          <button onclick="setStatus('{{ article.id }}', 'pending')" title="Reset to Pending">Pending</button>
          <button onclick="setStatus('{{ article.id }}', 'published')" title="Mark as Published" style="background: #f3e5f5;">Published</button>
          <button onclick="whyNot('{{ article.id }}', '{{ article.headline|e }}')" title="Reject with feedback" style="background: #fff3cd;">Why Not?</button>
          <button onclick="deleteArticle('{{ article.id }}')" title="Delete">Del</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if total_pages > 1 %}
  <div class="pagination">
    {% if page > 1 %}
    <a href="?page={{ page - 1 }}&status={{ filters.status or '' }}&min_score={{ filters.min_score or '' }}&source={{ filters.source or '' }}&search={{ filters.search or '' }}&sort={{ sort }}&dir={{ dir }}">Prev</a>
    {% endif %}

    <span>Page {{ page }} of {{ total_pages }}</span>

    {% if page < total_pages %}
    <a href="?page={{ page + 1 }}&status={{ filters.status or '' }}&min_score={{ filters.min_score or '' }}&source={{ filters.source or '' }}&search={{ filters.search or '' }}&sort={{ sort }}&dir={{ dir }}">Next</a>
    {% endif %}
  </div>
  {% endif %}

  <script>
    function updateBulkActions() {
      const selected = document.querySelectorAll('.row-select:checked').length;
      document.getElementById('selectedCount').textContent = selected;
      document.getElementById('bulkActions').classList.toggle('visible', selected > 0);
    }

    function toggleAll(checkbox) {
      document.querySelectorAll('.row-select').forEach(cb => cb.checked = checkbox.checked);
      updateBulkActions();
    }

    function getSelectedIds() {
      return Array.from(document.querySelectorAll('.row-select:checked')).map(cb => cb.value);
    }

    async function setStatus(id, action) {
      const response = await fetch('/admin/articles/' + id + '/' + action, { method: 'POST' });
      if (response.ok) {
        location.reload();
      } else {
        alert('Error updating article');
      }
    }

    async function deleteArticle(id) {
      if (!confirm('Delete this article?')) return;
      const response = await fetch('/admin/articles/' + id + '/delete', { method: 'POST' });
      if (response.ok) {
        location.reload();
      } else {
        alert('Error deleting article');
      }
    }

    async function bulkAction(action) {
      const ids = getSelectedIds();
      if (ids.length === 0) return;

      if (action === 'delete' && !confirm('Delete ' + ids.length + ' articles?')) return;

      // Warn about rejecting high-scoring articles
      if (action === 'reject') {
        const selectedRows = Array.from(document.querySelectorAll('.row-select:checked'))
          .map(cb => cb.closest('tr'));
        const highScoreCount = selectedRows.filter(row => {
          const scoreText = row.querySelector('.score')?.textContent?.trim();
          return scoreText && parseFloat(scoreText) >= 0.5;
        }).length;

        if (highScoreCount > 0) {
          if (!confirm('Warning: ' + highScoreCount + ' of ' + ids.length + ' selected articles have score >= 0.5.\n\nAre you sure you want to reject them?')) {
            return;
          }
        }
      }

      const response = await fetch('/admin/articles/bulk', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: ids, action: action })
      });

      if (response.ok) {
        location.reload();
      } else {
        alert('Error performing bulk action');
      }
    }

    function whyNot(id, headline) {
      const notes = prompt('Why should "' + headline.substring(0, 60) + '..." NOT be included?\n\nThis feedback helps improve the filter.');
      if (notes === null) return; // Cancelled

      fetch('/admin/articles/' + id + '/why_not', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ notes: notes })
      }).then(response => {
        if (response.ok) {
          location.reload();
        } else {
          alert('Error recording feedback');
        }
      });
    }
  </script>
</body>
</html>
